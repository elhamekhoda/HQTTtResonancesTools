stages:
  - setup
  - build
  - execute
  - test
  - deploy

variables:
  PACKAGE_NAME: HQTTtResonancesTools
  GIT_SSL_NO_VERIFY: "true"

.global: &global
  only:
    refs:
      - master

.analysis_image: &image
  image: lukasheinrich/recast_cvmfs_assisted:20161231
  tags:
    - cvmfs
  before_script:
    - pwd
    - ls
    - mkdir -p ~/.ssh
    - source ~/.bashrc || echo ignore alrb
    - echo "${SERVICE_PASS}" | kinit ${CERN_USER}@CERN.CH
    - klist
    - echo -e "Host svn.cern.ch lxplus.cern.ch\n\tUser ${CERN_USER}\n\tStrictHostKeyChecking no\n\tGSSAPIAuthentication yes\n\tGSSAPIDelegateCredentials yes\n\tProtocol 2\n\tForwardX11 no\n\tIdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - cat ~/.ssh/config

build_image:
  stage: deploy
  script:
    - ignore
  variables:
    FROM: atlas/analysistop:${AtlasVersion}
    CONTEXT_DIR: /
    BUILD_ARG_1: CI_JOB_TOKEN=${CI_JOB_TOKEN}
  tags:
    - docker-image-build
  <<: *global

deploy_ttresfullhad:
  image: lukasheinrich/recast_cvmfs_assisted:20161231
  stage: deploy
  script:
    - source ~/.bashrc || echo ignore alrb
    - lsetup git
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.cern.ch/atlas-phys/exot/hqt/tt_tb_Resonances_Run2/ttResFullHad.git -b latest
    - cd ttResFullHad
    - git submodule update --remote source/$PACKAGE_NAME
    - git commit -m "Canary build - ${PACKAGE_NAME}" -m "atlas-phys/exot/hqt/R21-ttbar-1lep/HQTTtResonancesTools@${CI_COMMIT_REF_SLUG}"
    - git push -u origin canary
  tags:
    - cvmfs
  <<: *global